# =============================================================================
# Endeavor SUPER CRM - Docker Compose Configuration
# For local development and production deployment
# =============================================================================

version: '3.8'

services:
  # -----------------------------------------------------------------------------
  # Main Application
  # -----------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        # These are passed at build time
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
        VITE_APP_ENV: ${VITE_APP_ENV:-production}
        VITE_APP_VERSION: ${VITE_APP_VERSION:-1.0.0}
        VITE_SECURITY_HEADERS_ENABLED: ${VITE_SECURITY_HEADERS_ENABLED:-true}
        VITE_CSP_MODE: ${VITE_CSP_MODE:-strict}
    container_name: endeavor-super-crm
    restart: unless-stopped
    ports:
      - "${PORT:-5176}:80"
    environment:
      # Runtime environment variables (if needed by nginx)
      - NGINX_WORKER_PROCESSES=auto
      - NGINX_WORKER_CONNECTIONS=1024
    healthcheck:
      test: ["CMD", "/usr/local/bin/docker-healthcheck.sh"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - crm-network
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # -----------------------------------------------------------------------------
  # Development Service (optional)
  # Run with: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
  # -----------------------------------------------------------------------------
  # dev:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #     target: development
  #   container_name: endeavor-super-crm-dev
  #   ports:
  #     - "5176:5176"
  #   volumes:
  #     - .:/app
  #     - /app/node_modules
  #   environment:
  #     - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
  #     - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
  #     - NODE_ENV=development
  #   networks:
  #     - crm-network

  # -----------------------------------------------------------------------------
  # Redis Cache (optional - for session/cache storage)
  # -----------------------------------------------------------------------------
  # redis:
  #   image: redis:7-alpine
  #   container_name: crm-redis
  #   restart: unless-stopped
  #   command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
  #   volumes:
  #     - redis-data:/data
  #   networks:
  #     - crm-network
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 256M

  # -----------------------------------------------------------------------------
  # Watchtower (optional - auto-update containers)
  # Automatically updates containers when new images are available
  # -----------------------------------------------------------------------------
  # watchtower:
  #   image: containrrr/watchtower
  #   container_name: crm-watchtower
  #   restart: unless-stopped
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   environment:
  #     - WATCHTOWER_POLL_INTERVAL=3600
  #     - WATCHTOWER_CLEANUP=true
  #     - WATCHTOWER_INCLUDE_STOPPED=true
  #     - WATCHTOWER_NOTIFICATIONS=email
  #     - WATCHTOWER_NOTIFICATION_EMAIL_FROM=alerts@yourdomain.com
  #     - WATCHTOWER_NOTIFICATION_EMAIL_TO=admin@yourdomain.com
  #     - WATCHTOWER_NOTIFICATION_EMAIL_SERVER=smtp.yourdomain.com
  #     - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT=587

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  crm-network:
    driver: bridge

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  redis-data:
    driver: local
